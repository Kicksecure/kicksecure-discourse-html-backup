<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Sdwdate design enhancements - Development - Kicksecure Forums</title>
    <meta name="description" content="Not sure there’s much to discuss here, this is just me doing a brain-dump of my research so that it’s not lost and so that others can comment on it as desirable. 
The current iteration of sdwdate does a pretty good job o&amp;hellip;">
    <meta name="generator" content="Discourse 3.4.7 - https://github.com/discourse/discourse version 3baf4000904c0d11731b97364df756b00d3457ee">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/1X/0db9935a1fdd7302cae516aaa752af0de307d388_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/1X/cbdfe4b0c05c97069961301225ed1ccd6e766f67_2_180x180.png">
<meta name="theme-color" media="all" content="#fff">

<meta name="color-scheme" content="light">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<link rel="canonical" href="1203.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="Kicksecure Forums Search">

    <link href="../../stylesheets/color_definitions_base__3_58d3e6a62bbcfd837d27bf50c11c162268923430.css_%3b%20filename_%3dUTF-8%27%27color_definitions_base__3_58d3e6a62bbcfd837d27bf50c11c1622689234306?__ws=forums.kicksecure.com" media="all" rel="stylesheet" class="light-scheme"/>

  <link href="../../stylesheets/desktop_27a873e6f6411872159c8df0158556932392cab2.css_%3b%20filename_%3dUTF-8%27%27desktop_27a873e6f6411872159c8df0158556932392cab261cf.css?__ws=forums.kicksecure.com" media="all" rel="stylesheet" data-target="desktop"  />



  <link href="../../stylesheets/checklist_27a873e6f6411872159c8df0158556932392cab2.css_%3b%20filename_%3dUTF-8%27%27checklist_27a873e6f6411872159c8df0158556932392cab261cf.css?__ws=forums.kicksecure.com" media="all" rel="stylesheet" data-target="checklist"  />
  <link href="../../stylesheets/discourse-details_27a873e6f6411872159c8df0158556932392cab2.css_%3b%20filename_%3dUTF-8%27%27discourse-details_27a873e6f6411872159c8df0158556932392cab261cf.css?__ws=forums.kicksecure.com" media="all" rel="stylesheet" data-target="discourse-details"  />
  <link href="../../stylesheets/discourse-lazy-videos_27a873e6f6411872159c8df0158556932392cab2.css_%3b%20filename_%3dUTF-8%27%27discourse-lazy-videos_27a873e6f6411872159c8df0158556932392cab261cf.css?__ws=forums.kicksecure.com" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
  <link href="../../stylesheets/discourse-local-dates_27a873e6f6411872159c8df0158556932392cab2.css_%3b%20filename_%3dUTF-8%27%27discourse-local-dates_27a873e6f6411872159c8df0158556932392cab261cf.css?__ws=forums.kicksecure.com" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
  <link href="../../stylesheets/discourse-narrative-bot_27a873e6f6411872159c8df0158556932392cab2.css_%3b%20filename_%3dUTF-8%27%27discourse-narrative-bot_27a873e6f6411872159c8df0158556932392cab261cf?__ws=forums.kicksecure.com" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
  <link href="../../stylesheets/discourse-presence_27a873e6f6411872159c8df0158556932392cab2.css_%3b%20filename_%3dUTF-8%27%27discourse-presence_27a873e6f6411872159c8df0158556932392cab261cf.css?__ws=forums.kicksecure.com" media="all" rel="stylesheet" data-target="discourse-presence"  />
  <link href="../../stylesheets/docker_manager_27a873e6f6411872159c8df0158556932392cab2.css_%3b%20filename_%3dUTF-8%27%27docker_manager_27a873e6f6411872159c8df0158556932392cab261cf.css?__ws=forums.kicksecure.com" media="all" rel="stylesheet" data-target="docker_manager"  />
  <link href="../../stylesheets/footnote_27a873e6f6411872159c8df0158556932392cab2.css_%3b%20filename_%3dUTF-8%27%27footnote_27a873e6f6411872159c8df0158556932392cab261cf.css?__ws=forums.kicksecure.com" media="all" rel="stylesheet" data-target="footnote"  />
  <link href="../../stylesheets/poll_27a873e6f6411872159c8df0158556932392cab2.css_%3b%20filename_%3dUTF-8%27%27poll_27a873e6f6411872159c8df0158556932392cab261cf.css?__ws=forums.kicksecure.com" media="all" rel="stylesheet" data-target="poll"  />
  <link href="../../stylesheets/poll_desktop_27a873e6f6411872159c8df0158556932392cab2.css_%3b%20filename_%3dUTF-8%27%27poll_desktop_27a873e6f6411872159c8df0158556932392cab261cf.css?__ws=forums.kicksecure.com" media="all" rel="stylesheet" data-target="poll_desktop"  />

  <link href="../../stylesheets/desktop_theme_3_a6149e272e30d7f0925ea74416c90af282eea4c8.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_3_a6149e272e30d7f0925ea74416c90af282eea4c861cf.css?__ws=forums.kicksecure.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="3" data-theme-name="graceful"/>
<link href="../../stylesheets/desktop_theme_2_f12616e0ab837bd2681302351e35914a09eb0a92.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_2_f12616e0ab837bd2681302351e35914a09eb0a9261cf.css?__ws=forums.kicksecure.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2" data-theme-name="header"/>

    <!--
START custom CSS / JS

Configured here:
https://forums.kicksecure.com/admin/customize/themes/2/common/head_tag/edit
-->

<!-- START End of Year Banner -->


<!-- Not needed currently because banner inactive
<link rel="stylesheet" href="/mw-autogen/src-copy/CodeSelect.css">
<link rel="stylesheet" href="/mw-autogen/src-copy/PayViaPaypal.css">
<link rel="stylesheet" href="/mw-autogen/src-copy/Sitenotice_EndOfYear.css">
-->

<!-- Not needed currently because banner inactive
<script type="text/javascript" defer src="/mw-autogen/src-copy/CodeSelect.js"></script>
<script type="text/javascript" defer src="/mw-autogen/src-copy/PayViaPaypal.js"></script>
<script type="text/javascript" defer src="/mw-autogen/src-copy/Sitenotice_EndOfYear.js"></script>
-->

<style type="text/css">
  #donate-end-of-year div,
  #donate-end-of-year span,
  #donate-end-of-year a {
    box-sizing: border-box;
  }
  
  #end-of-year-banner-wrapper {
      margin: 0 10px 25px;
  }

  #donate-end-of-year i {
    width: 20px;
    height: 20px;
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    filter: brightness(2);
    display: inline-block;
  }

  #donate-end-of-year i.dismiss {
    background-image: url('../../w/images/0/0b/End-of-year-times.png');
  }

  #donate-end-of-year .slideshow > .content img {
    float: left;
    margin-right: 20px;
  }

  #donate-end-of-year .slideshow .flow i {
    cursor: pointer;
    filter: brightness(1);
    height: 17px;
    width: 17px;
    vertical-align: middle;
  }

  #donate-end-of-year .slideshow .flow i.is-play {
    background-image: url('../../w/images/3/32/End-of-year-pause.png');
  }

  #donate-end-of-year .slideshow .flow i.is-pause {
    background-image: url('../../w/images/c/c8/End-of-year-play.png');
  }

</style>



<!-- END End of Year Banner -->

<!--
END custom CSS / JS
-->

    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Sdwdate design enhancements&#39;" href="1203.rss" />
    <meta property="og:site_name" content="Kicksecure Forums" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forums.kicksecure.com/uploads/default/original/1X/cbdfe4b0c05c97069961301225ed1ccd6e766f67.png" />
<meta property="og:image" content="https://forums.kicksecure.com/uploads/default/original/1X/cbdfe4b0c05c97069961301225ed1ccd6e766f67.png" />
<meta property="og:url" content="https://forums.kicksecure.com/t/sdwdate-design-enhancements/1203" />
<meta name="twitter:url" content="https://forums.kicksecure.com/t/sdwdate-design-enhancements/1203" />
<meta property="og:title" content="Sdwdate design enhancements" />
<meta name="twitter:title" content="Sdwdate design enhancements" />
<meta property="og:description" content="Not sure there’s much to discuss here, this is just me doing a brain-dump of my research so that it’s not lost and so that others can comment on it as desirable.  The current iteration of sdwdate does a pretty good job of keeping the system’s clock accurate but skewed just enough to provide better anonymity under Whonix. However, it has a few shortcomings we’d like to resolve:   It only sets the time for the (virtual) machine it runs on, it isn’t able to act as a server for helping other virtual..." />
<meta name="twitter:description" content="Not sure there’s much to discuss here, this is just me doing a brain-dump of my research so that it’s not lost and so that others can comment on it as desirable.  The current iteration of sdwdate does a pretty good job of keeping the system’s clock accurate but skewed just enough to provide better anonymity under Whonix. However, it has a few shortcomings we’d like to resolve:   It only sets the time for the (virtual) machine it runs on, it isn’t able to act as a server for helping other virtual..." />
<meta property="og:article:section" content="Development" />
<meta property="og:article:section:color" content="25AAE2" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="2 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="1 ❤" />
<meta property="article:published_time" content="2025-08-08T19:24:55+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    <div class="background-container"></div>
<div class="header-brand-nav">
    <a class="home" href="../../../external.html?link=https://www.kicksecure.com/">Kicksecure Wiki</a>
    <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Download">Download</a>
    <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Documentation">Docs</a>
    <a href="../../c/news/5.html">News</a>
    <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Support">Support</a>
    <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Forum_Best_Practices">Tips</a>
    <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Reporting_Bugs#Issue_Tracker">Issues</a>
    <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Contribute">Contribute</a>
    <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Donate">DONATE</a>
</div>
    <header>
  <a href="../../index.html">
    Kicksecure Forums
  </a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="1203.html">Sdwdate design enhancements</a>
    </h1>

      <div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="../../c/development/7.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

  </div>

  

    <div itemscope itemtype='../../../external.html?link=http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='Sdwdate design enhancements'>
      <link itemprop='url' href='1203.html'>
      <meta itemprop='datePublished' content='2025-08-08T19:24:55Z'>
        <meta itemprop='articleSection' content='Development'>
      <meta itemprop='keywords' content=''>
      <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
        <meta itemprop='name' content='Kicksecure - a secure by default operating system'>
          <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
            <meta itemprop='url' content='../../uploads/default/original/1X/b25d14d50e56313c399bc031caf564b64756e72b.png'>
          </div>
      </div>


          <div id='post_1'  class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../../external.html?link=https://forums.kicksecure.com/u/arraybolt3'><span itemprop='name'>arraybolt3</span></a>
                
              </span>

                <link itemprop="mainEntityOfPage" href="1203.html">


              <span class="crawler-post-infos">
                  <time  datetime='2025-08-08T19:24:55Z' class='post-time'>
                    August 8, 2025,  7:24pm
                  </time>
                  <meta itemprop='dateModified' content='2025-08-08T20:39:15Z'>
              <span itemprop='position'>1</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Not sure there’s much to discuss here, this is just me doing a brain-dump of my research so that it’s not lost and so that others can comment on it as desirable.</p>
<p>The current iteration of sdwdate does a pretty good job of keeping the system’s clock accurate but skewed just enough to provide better anonymity under Whonix. However, it has a few shortcomings we’d like to resolve:</p>
<ul>
<li>It only sets the time for the (virtual) machine it runs on, it isn’t able to act as a server for helping other virtual machines running on the same system to also synchronize their time securely. This is something that would be nice to fix in Qubes OS, allowing sys-whonix (or more likely, sys-ops-whonix once that exists) to act as a master time-keeper for all VMs.</li>
<li>The current way it adjusts the clock is somewhat awful - it does a large clock jump or two to get the time close enough to accurate to allow connecting to Tor, then does a large number of small clock jumps to get the time to a final “good” value. Clock jump confuse software in multiple ways, and the small clock jumps we do currently can result in systemd journal being flooded, so they’re best avoided, and if they’re needed, it’s best to do one clock jump and then slew the clock to the correct time using something like <code>adjtimex</code>.</li>
</ul>
<p>The core sdwdate code is good and should probably not change too much. What should probably change is the <code>sclockadj</code> tool that is used for doing small clock jumps, and we need a way to allow sdwdate to provide time values for other VMs to sync themselves to.</p>
<hr>
<p>The below is my research into using adjtimex, The tl;dr: is that <strong>we probably should not use adjtimex for initial clock synchronization after boot, but it may be usable to keep the clock in sync thereafter.</strong></p>
<p>Properly adjusting a clock using <code>adjtime</code> or <code>adjtimex</code> (slewing it to the correct value using in-kernel support) is very, very slow. According to <a href="../../../external.html?link=https://unix.stackexchange.com/a/188620/535873" class="inline-onebox" rel="noopener nofollow ugc">time - How long will NTP take to adjust the clock if it doesn't immediately set it? - Unix &amp; Linux Stack Exchange</a> it takes approximately 4.17 minutes to adjust the clock by 128 milliseconds, or at least it did in 2015. In my testing with adjtimex, this is still approximately correct - it appears that adjtimex adjusts the clock by 500 microseconds per second. This means it takes a little over 33 minutes to adjust the clock by one second.</p>
<p>The problem with this is that Tor (and therefore sdwdate) only allow us to resolve time to within a second at best because that’s the resolution of the HTTP headers we get. On top of that, we get the time from three different servers at once when using sdwdate and then go with the median value of those three times, meaning that in practice we’re not going to be within a second of accuracy because of network lag and all sorts of other things NTP is designed to work around and Tor isn’t. On top of that, we also randomize the clock a bit for greater anonymity, meaning that we might change the clock several seconds on each invocation of sdwdate. When it takes over half an hour to move the clock by one second, making a multi-second change will take <em>hours</em>. Now if we assume that the system’s clock is fairly accurate, and we only ever have <em>one</em> time randomization offset per session (generated randomly each session but never changed until the next reboot, I guess), we can probably skew the clock by a second or two on each sdwdate invocation without too much trouble. But if the network is shaky (for instance, the user is using cellular internet in bad conditions), it’s likely sdwdate will be trying to make much larger changes.</p>
<p>(Note, anecdotally it seems that sdwdate doesn’t see any particular need to change the clock in my KVM virtual machine when I restart sdwdate, at least while my network is working well. The median time difference keeps being 0. That being said, other time differences were frequently reported that were not the median, so I assume that users won’t always get this lucky.)</p>
<p>The current <code>sclockadj</code> code adjusts the clock by 5 million nanoseconds per second. This is <em>ten times</em> faster than adjtimex, which adjusts by 5 hundred thousand nanoseconds per second. Thus sclockadj can handle multi-second adjustments without too much grief, but only by doing clock jumps. Switching to clock slewing with adjtimex will slow down our time adjustments very much.</p>
<p>The 500 microseconds per second adjustment rate is not configurable, it is unfortunately hardcoded in the kernel’s NTP code, which the <code>adjtimex</code> system call uses to do its work of slewing the clock. There isn’t any way to do a “fast slew” to my awareness, unless we want to try to contribute a feature for this to the kernel (which… might be possible?).</p>
<p>Based on the above, I think we might get away with using adjtimex to keep the clock in sync once it is initially synchronized. For making an adjustment of a second or two, it’s probably enough. But on first boot, when the clock is most likely to be several seconds slow or fast (especially on machines with no BIOS battery or a broken battery), we probably need to just use a clock jump. This is similar to the behavior of ntpd.</p>
<hr>
<p>For making sdwdate able to act as a server under Qubes OS, there are a couple of issues to deal with:</p>
<ul>
<li>Qubes OS currently synchronizes all VMs to dom0’s time, at least when resuming after suspend. But we would like for dom0 to be able to synchronize itself to sys-(ops-)whonix also.</li>
<li>Every VM on the system should ideally have slightly different time, and should get their time values from a different sdwdate time sync invocation (to avoid one bad sync affecting all VMs on the system).</li>
</ul>
<p>To work with the first issue, we can simply have all VMs (including sys-(ops-)whonix) blindly trust dom0’s time to begin with. Once a successful sdwdate sync is done however, the VM should record how its time differs from dom0’s time. Then, on resume-from-suspend, the VM can take the time given to it by dom0, and adjust it by the offset before syncing the clock. Any time dom0’s clock changed, it would have to announce this to all running VMs so they could recalculate their offsets from dom0.</p>
<p>To work around the second issue, we need some way for a virtual machine to get “whatever the current time is +/- some fixed offset” each time they synchronize their clock with the ClockVM. The fixed offset should be unique per-machine and per-boot, but should be constant between boots to avoid needing lots of clock jumps forward and backward. To acheive this, the client process that gets the time from the ClockVM should create a random identifier on launch, and present that identifier to sdwdate every time it syncs the clock. When sdwdate sees an identifier it hasn’t seen previously, it should generate a new random offset, but if it sees an identifier it’s seen previously, it should use the same offset it presented last time. This way each VM can have its time a little bit different, but that “little bit different” will be static for each virtual machine (until the client VM or ClockVM is rebooted, at least).</p>
<p>We don’t have to tack a bunch of code onto the existing sdwdate code base in order to make it able to act like a server. We should just create a new server process that serves whatever the ClockVM’s current time is (+/- the fixed offset described earlier) to clients. This probably won’t be very difficult to do at all. We will need this server process to NOT serve time until after sdwdate has synced the clock, but thankfully sdwdate already reports its status to other processes on the same VM, so we can rely on that.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>

          </div>
    </div>


    




    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../index.html' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../categories.html' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../guidelines.html' itemprop="url">Guidelines </a>
        </span>
      </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://www.kicksecure.com/wiki/Terms_of_Service' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://www.kicksecure.com/wiki/Privacy_Policy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    <div class="footer-brand-nav">
    <div class="legal">
        By using this website, you acknowledge you have read, understood, and agree to be bound by these these agreements:
        <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Terms_of_Service" title="Terms of Service">Terms of Service</a>, and
        <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Privacy_Policy" title="Privacy Policy">Privacy Policy</a>,
        <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Cookie_Policy" title="Cookie Policy">Cookie Policy</a>,
        <a href="../../../external.html?link=https://www.kicksecure.com/wiki/E-Sign_Consent" title="E-Sign Consent">E-Sign Consent</a>
        <a href="../../../external.html?link=https://www.kicksecure.com/wiki/DMCA">DMCA</a>
        <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Imprint">Imprint</a>
    </div>
</div>

    <noscript>
    <div class="footer-brand-nav">
        <div class="legal">
            By using this website, you acknowledge you have read, understood, and agree to be bound by these these agreements:
            <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Terms_of_Service" title="Terms of Service">Terms of Service</a>, and
            <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Privacy_Policy" title="Privacy Policy">Privacy Policy</a>,
            <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Cookie_Policy" title="Cookie Policy">Cookie Policy</a>,
            <a href="../../../external.html?link=https://www.kicksecure.com/wiki/E-Sign_Consent" title="E-Sign Consent">E-Sign Consent</a>
            <a href="../../../external.html?link=https://www.kicksecure.com/wiki/DMCA">DMCA</a>
            <a href="../../../external.html?link=https://www.kicksecure.com/wiki/Imprint">Imprint</a>
        </div>
    </div>

    <style type="text/css">
        /* Here is room for styles for when Javascript is deactivated */
    </style>
</noscript>
  </body>
  
</html>
